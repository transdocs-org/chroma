# 架构

Chroma 的设计采用了模块化架构，优先考虑性能和易用性。它能够从本地开发无缝扩展到大规模生产环境，同时在所有部署模式下提供一致的 API。

Chroma 尽可能地将数据持久化的问题交由 SQLite 和云对象存储等可靠的子系统来处理，从而将系统设计的重点集中在数据管理和信息检索的核心问题上。

## 部署模式

Chroma 可以在你需要的任何地方运行，支持从本地实验到大规模生产工作负载的各种场景。

- **本地模式**：作为嵌入式库使用 —— 非常适合原型设计和实验。
- **单节点模式**：作为单节点服务器运行 —— 非常适合处理少量集合中低于 1000 万条记录的小型至中型工作负载。
- **分布式模式**：作为可扩展的分布式系统运行 —— 非常适合大规模生产工作负载，支持数百万个集合。

你也可以使用 [Chroma Cloud](https://www.trychroma.com/signup)，这是分布式 Chroma 的托管服务版本。

## 核心组件

无论采用哪种部署模式，Chroma 都由五个核心组件构成。每个组件在系统中都有明确的角色，并基于共享的 [Chroma 数据模型](../overview/data-model) 运行。

{% MarkdocImage lightSrc="/system-diagram-light.png" darkSrc="/system-diagram-dark.png" alt="Chroma 系统架构" /%}

### 网关（The Gateway）

所有客户端流量的入口。

- 在所有模式下提供统一的 API 接口。
- 处理身份验证、速率限制、配额管理以及请求验证。
- 将请求路由到下游服务。

### 日志（The Log）

Chroma 的预写日志（Write-ahead Log）。

- 所有写入操作在确认返回给客户端之前都会先记录于此。
- 确保多记录写入操作的原子性。
- 在分布式部署中提供持久化和日志重放能力。

### 查询执行器（The Query Executor）

负责**所有的读取操作**。

- 支持向量相似度、全文和元数据搜索。
- 维护内存和磁盘索引的组合，并与日志组件协调，以提供一致性的查询结果。

### 压缩器（Compactor）

一个定期构建和维护索引的服务。

- 从日志中读取数据，构建更新的向量索引 / 全文索引 / 元数据索引。
- 将物化后的索引数据写入共享存储。
- 在系统数据库中更新关于新索引版本的元数据。

### 系统数据库（System Database）

Chroma 的内部目录服务。

- 跟踪租户、集合及其元数据。
- 在分布式模式下，还管理集群状态（例如查询节点 / 压缩器节点的成员关系）。
- 基于 SQL 数据库实现。

## 存储与运行时（Storage & Runtime）

这些组件的行为会根据部署模式的不同而有所变化，特别是在存储使用方式和运行时环境方面。

- 在本地（Local）和单节点（Single Node）模式下，所有组件共享一个进程，并使用本地文件系统保证数据持久性。
- 在**分布式**模式下，组件作为独立服务进行部署。
    - 日志和构建好的索引存储在云对象存储中。
    - 系统目录服务由 SQL 数据库提供支持。
    - 所有服务使用本地 SSD 作为缓存，以减少对象存储的延迟和成本。

## 请求流程

### 读取路径

{% MarkdocImage lightSrc="/read-path-light.png" darkSrc="/read-path-dark.png" alt="Chroma 系统读取路径" /%}

1. 请求到达网关，在这里进行身份验证、配额检查、速率限制，并被转换为一个逻辑计划。
2. 此逻辑计划会被路由到相应的查询执行器。在分布式 Chroma 中，使用基于集合 ID 的环状哈希（rendezvous hash）将查询路由到正确的节点，并保持缓存一致性。
3. 查询执行器将逻辑计划转换为物理执行计划，从存储层读取数据并执行查询。查询执行器会从日志中拉取数据以确保一致性读取。
4. 请求结果返回网关，再返回给客户端。

### 写入路径

{% MarkdocImage lightSrc="/write-path-light.png" darkSrc="/write-path-dark.png" alt="Chroma 系统写入路径" /%}

1. 请求到达网关，在这里进行身份验证、配额检查、速率限制，并被转换为操作日志。
2. 操作日志被转发到预写日志（write-ahead-log）以实现持久化。
3. 在预写日志完成持久化后，网关确认写入操作成功。
4. 压缩器（compactor）定期从预写日志中拉取数据，并根据累积的写入操作构建新的索引版本。这些索引针对读取性能进行了优化，包含向量索引、全文索引和元数据索引。
5. 新的索引版本构建完成后，会被写入存储系统并在系统数据库中注册。

## 权衡考量

为了确保数据的持久性并实现低成本，分布式 Chroma 构建在对象存储之上。对象存储具有极高的吞吐量，能够轻松占满单个节点的网络带宽，但这也带来了大约 10-20 毫秒的较高延迟基线。

为了减少这种延迟基线带来的开销，分布式 Chroma 积极利用 SSD 缓存。当您首次查询某个集合时，系统会选择性地从对象存储中读取回答查询所需的一部分数据，此时会带来冷启动的延迟惩罚。在后台，SSD 缓存将加载该集合的数据。当集合完全预热后，查询将完全由 SSD 提供服务。